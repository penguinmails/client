name: CI - Lint, TypeCheck, Tests & Build

on:
  push:
    branches: [ main, dev ]
    paths:
      - '**/*.ts'
      - '**/*.tsx'
      - '**/*.js'
      - '**/*.jsx'
      - 'package.json'
      - 'tsconfig*.json'
      - 'next.config.*'
      - 'tailwind.config.*'
  pull_request:
    branches: [ main, dev ]
    types: [opened, synchronize, reopened]
    paths:
      - '**/*.ts'
      - '**/*.tsx'
      - '**/*.js'
      - '**/*.jsx'
      - 'package.json'
      - 'tsconfig*.json'
      - 'next.config.*'
      - 'tailwind.config.*'

jobs:
  # Job 1: Run linting checks
  lint:
    name: ESLint Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run ESLint
      run: npm run lint:ci
      env:
        CI: true

  # Job 2: Run TypeScript type checking
  typecheck:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run TypeScript type check
      run: npm run typecheck
      env:
        CI: true

  # Job 3: Run tests
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run Jest tests
      run: npm run test
      env:
        CI: true

  # Job 4: Build verification
  build:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run build
      run: npm run build
      env:
        NILEDB_API_URL: ${{ secrets.NILEDB_API_URL }}
        NILEDB_USER: ${{ secrets.NILEDB_USER }}
        NILEDB_PASSWORD: ${{ secrets.NILEDB_PASSWORD }}
        NILEDB_POSTGRES_URL: ${{ secrets.NILEDB_POSTGRES_URL }}
        REDIS_URL: ${{ secrets.REDIS_URL }}
        # Add other required environment variables
        NEXT_PUBLIC_MAX_LOGIN_ATTEMPTS: ${{ secrets.NEXT_PUBLIC_MAX_LOGIN_ATTEMPTS }}
        NEXT_PUBLIC_TURNSTILE_SITE_KEY: ${{ secrets.NEXT_PUBLIC_TURNSTILE_SITE_KEY }}

  # Job 5: Summary
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test, build]
    if: always()
    
    steps:
    - name: All checks passed
      run: |
        echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Job Results" >> $GITHUB_STEP_SUMMARY
        echo "- ESLint: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- TypeScript: ${{ needs.typecheck.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Tests: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… CI pipeline completed!" >> $GITHUB_STEP_SUMMARY
