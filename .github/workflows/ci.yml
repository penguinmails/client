name: CI - Lint, TypeCheck, Tests & Build

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]
    types: [opened, synchronize, reopened]

jobs:
  # Job 1: Run linting checks
  lint:
    name: ESLint Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run ESLint
      run: npm run lint
      env:
        CI: true

  # Job 2: Run TypeScript type checking
  typecheck:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run TypeScript type check
      run: npm run typecheck
      env:
        CI: true

  # Job 3: Run tests
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run Jest tests
      run: npm run test
      env:
        CI: true

  # Job 4: Build verification
  build:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run build
      run: npm run build
      env:
        NILEDB_API_URL: ${{ secrets.NILEDB_API_URL }}
        NILEDB_USER: ${{ secrets.NILEDB_USER }}
        NILEDB_PASSWORD: ${{ secrets.NILEDB_PASSWORD }}
        NILEDB_POSTGRES_URL: ${{ secrets.NILEDB_POSTGRES_URL }}
        CONVEX_DEPLOYMENT: ${{ secrets.CONVEX_DEPLOYMENT }}
        NEXT_PUBLIC_CONVEX_URL: ${{ secrets.NEXT_PUBLIC_CONVEX_URL }}
        REDIS_URL: ${{ secrets.REDIS_URL }}
        # Add other required environment variables
        NEXT_PUBLIC_MAX_LOGIN_ATTEMPTS: ${{ secrets.NEXT_PUBLIC_MAX_LOGIN_ATTEMPTS }}
        NEXT_PUBLIC_TURNSTILE_SITE_KEY: ${{ secrets.NEXT_PUBLIC_TURNSTILE_SITE_KEY }}

  # Job 5: Summary
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test, build]
    
    steps:
    - name: All checks passed
      run: |
        echo "âœ… All CI checks passed successfully!"
        echo "- ESLint: ${{ needs.lint.result }}"
        echo "- TypeScript: ${{ needs.typecheck.result }}"
        echo "- Tests: ${{ needs.test.result }}"
        echo "- Build: ${{ needs.build.result }}"
