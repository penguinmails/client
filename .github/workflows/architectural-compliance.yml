name: Architectural Compliance

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  architectural-compliance:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # Need previous commit for diff analysis

    - name: Setup Node.js 22
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run architectural compliance tests
      run: npm test -- --testPathPatterns="app-layer-integration|cross-feature-integration|design-token-compliance"
      env:
        CI: true
        NODE_ENV: test
    
    - name: Generate architectural compliance report
      if: always()
      run: echo "Architectural tests completed" > architectural-compliance-report.txt

  fsd-validation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for comprehensive analysis
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Validate FSD import paths
      run: npm run fsd:validate -- --report=json

  design-token-compliance:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Check for hardcoded styles
      run: |
        echo "Checking for hardcoded hex colors..."
        if grep -r "#[0-9A-Fa-f]\{3,8\}" components/ features/ app/ --include="*.tsx" --include="*.ts" | head -20; then
          echo "‚ö†Ô∏è Hardcoded colors found (showing first 20)"
        else
          echo "‚úÖ No hardcoded colors found"
        fi
        
        echo "Checking for arbitrary spacing values..."
        if grep -r "\w\+-\[[^\]]\+\]" components/ features/ app/ --include="*.tsx" --include="*.ts" | head -10; then
          echo "‚ö†Ô∏è Arbitrary spacing values found (showing first 10)"
        else
          echo "‚úÖ No arbitrary spacing values found"
        fi

  regression-prevention:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Fail on critical violations
      run: |
        # This step ensures the workflow fails if critical violations are found
        npm run fsd:validate --silent || {
          echo "‚ùå Critical FSD violations found"
          echo "Please fix architectural violations before merging"
          exit 1
        }

  quality-gates:
    runs-on: ubuntu-latest
    needs: [architectural-compliance, fsd-validation, design-token-compliance]
    if: always()
    
    steps:
    - name: Check quality gates
      run: |
        echo "Checking quality gates..."
        
        # Check if any required jobs failed
        if [[ "${{ needs.architectural-compliance.result }}" == "failure" ]]; then
          echo "‚ùå Architectural compliance tests failed"
          exit 1
        fi
        
        if [[ "${{ needs.fsd-validation.result }}" == "failure" ]]; then
          echo "‚ùå FSD validation failed"
          exit 1
        fi
        
        if [[ "${{ needs.design-token-compliance.result }}" == "failure" ]]; then
          echo "‚ùå Design token compliance failed"
          exit 1
        fi
        
        echo "‚úÖ All quality gates passed"
    
    - name: Post success status
      if: success()
      run: |
        echo "üéâ All architectural compliance checks passed!"
        echo "The codebase maintains proper FSD architecture and design token usage."
